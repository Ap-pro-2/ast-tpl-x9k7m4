---
import { getAllPosts, getSiteSettings, formatDate } from '../../core/blogLogic';
import { getCollection } from 'astro:content';
import OptimizedImage from '../ui/OptimizedImage.astro';
import { getBadgeStyleString } from '../../core/utils/colorUtils';
import { getPostUrl } from '../../core/urlRouting';


const posts = await getAllPosts();
const settings = await getSiteSettings();
const allCategories = await getCollection('categories');


function getCategoryData(categoryRef: string | { id: string } | undefined) {
  if (!categoryRef) return { name: null, color: 'var(--color-primary)' };
  
  const categoryId = typeof categoryRef === 'string' ? categoryRef : categoryRef.id;
  const category = allCategories.find(cat => cat.data.id === categoryId || cat.id === categoryId);
  return {
    name: category?.data.name || null,
    color: category?.data.color || 'var(--color-primary)'
  };
}


const sliderPosts = posts.slice(0, 10);

// Generate URLs for slider posts
const sliderPostUrls = await Promise.all(sliderPosts.map(post => getPostUrl(post.id)));
---

<section class="section3-slider py-12 lg:py-16" style="background: var(--bg-primary)">
  <div class="container max-w-7xl">
    
    <div class="slider-header">
      <div class="slider-header-content">
        <div class="slider-section-line"></div>
        <h2 class="slider-section-title">Editors' Picks</h2>
      </div>
      
      <div class="slider-navigation">
        <button class="slider-nav-btn slider-prev" aria-label="Previous articles">
          <svg class="slider-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>
        <button class="slider-nav-btn slider-next" aria-label="Next articles">
          <svg class="slider-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </button>
      </div>
    </div>

    <div class="slider-container">
      <div class="slider-track" id="editorsPicksTrack">
        {sliderPosts.map((post, index) => (
          <article class="slider-card">
            <a href={sliderPostUrls[index]} class="slider-card-link">
              
              {post.data.image?.url && (
                <div class="slider-card-image">
                  <OptimizedImage 
                    src={post.data.image.url} 
                    alt={post.data.image.alt || post.data.title}
                    width={280}
                    height={200}
                    class="w-full h-full object-cover"
                  />
                  
                </div>
              )}
              
              <div class="slider-card-content">
                {getCategoryData(post.data.category).name && (
                  <div class="slider-category-section">
                    <span class="slider-category-badge"
                          style={getBadgeStyleString(getCategoryData(post.data.category).color)}>
                      {(getCategoryData(post.data.category).name || 'General').toUpperCase()}
                    </span>
                  </div>
                )}

                <h3 class="slider-card-title">
                  {post.data.title}
                </h3>
                
                <div class="slider-card-meta">
                  <time datetime={post.data.pubDate.toISOString()}>
                    {formatDate(post.data.pubDate)}
                  </time>
                </div>
              </div>
            </a>
          </article>
        ))}
      </div>
    </div>

    <div class="slider-dots" id="sliderDots">
      {Array.from({ length: Math.ceil(sliderPosts.length / 4) }, (_, i) => (
        <button class="slider-dot" data-slide={i} aria-label={`Go to slide ${i + 1}`}></button>
      ))}
    </div>
  </div>
</section>

<style>
/* Professional category styling for slider - positioned in content, not over images */
.slider-category-section {
  margin-bottom: 0.75rem;
}

.slider-category-badge {
  display: inline-block;
  padding: 0.375rem 0.875rem;
  font-size: 0.7rem;
  font-weight: 600;
  border-radius: 6px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  line-height: 1;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  transition: all 0.2s ease;
}

.slider-category-badge:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
}

/* Mobile adjustments */
@media (max-width: 768px) {
  .slider-category-badge {
    font-size: 0.65rem;
    padding: 0.3rem 0.7rem;
  }

  .slider-category-section {
    margin-bottom: 0.5rem;
  }
}

@media (max-width: 480px) {
  .slider-category-badge {
    font-size: 0.6rem;
    padding: 0.25rem 0.6rem;
  }
}
</style>

<script src="../../scripts/section3-slider.ts"></script>