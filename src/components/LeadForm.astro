---
interface Props {
  source?: string;
}

const { source = 'website' } = Astro.props;
---

<div class="theme-form-container">
  <div id="error-message" class="theme-form-error" style="display: none;">
    <p>Unable to save your email. Please try again.</p>
  </div>

  <div id="success-message" class="theme-form-success" style="display: none;">
    <p>Thank you! Your email has been saved.</p>
  </div>

  <form id="newsletter-form">
    <div class="theme-form-group">
      <input
        type="email"
        id="email"
        name="email"
        required
        placeholder="Enter your email address"
        class="theme-form-input"
      />
      <p id="email-error" class="theme-form-field-error" style="display: none;"></p>
    </div>
    
    <!-- Hidden input for source tracking -->
    <input type="hidden" name="source" value={source} />
    
    <button type="submit" class="theme-form-submit" id="submit-btn">
      Subscribe
    </button>
  </form>
</div>

<script>
  import { actions } from 'astro:actions';

  const form = document.getElementById('newsletter-form') as HTMLFormElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const emailInput = document.getElementById('email') as HTMLInputElement;
  const emailError = document.getElementById('email-error') as HTMLParagraphElement;
  const errorMessage = document.getElementById('error-message') as HTMLDivElement;
  const successMessage = document.getElementById('success-message') as HTMLDivElement;

  // Hide all messages initially
  function hideMessages() {
    errorMessage.style.display = 'none';
    successMessage.style.display = 'none';
    emailError.style.display = 'none';
  }

  // Show loading state
  function setLoading(loading: boolean) {
    submitBtn.disabled = loading;
    submitBtn.textContent = loading ? 'Subscribing...' : 'Subscribe';
  }

  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    hideMessages();
    setLoading(true);

    try {
      const formData = new FormData(form);
      const { data, error } = await actions.leads(formData);

      setLoading(false);

      if (error) {
        console.error('Action error:', error);
        
        // Check for validation errors first
        if (error.code === 'BAD_REQUEST' && error.fields?.email) {
          emailError.textContent = error.fields.email.join(', ');
          emailError.style.display = 'block';
        } else {
          // Show general error message
          errorMessage.style.display = 'block';
        }
      } else {
        console.log('Success:', data);
        // Show success message and reset form
        successMessage.style.display = 'block';
        successMessage.style.visibility = 'visible';
        form.reset();
        
        // Hide success message after 5 seconds
        setTimeout(() => {
          successMessage.style.display = 'none';
        }, 5000);
      }
    } catch (err) {
      console.error('Network error:', err);
      setLoading(false);
      errorMessage.style.display = 'block';
    }
  });
</script>